// Copyright Â© 2024 Jonas Frey. All rights reserved.

import Foundation

fileprivate let playerSymbols = Direction.allCases.map(\.playerSymbol)

fileprivate enum Direction: CaseIterable, Hashable {
    case up
    case down
    case left
    case right
    
    var directionVector: Position {
        switch self {
        case .up:
            return .init(x: 0, y: -1)
        case .down:
            return .init(x: 0, y: 1)
        case .left:
            return .init(x: -1, y: 0)
        case .right:
            return .init(x: 1, y: 0)
        }
    }
    
    var playerSymbol: String {
        switch self {
        case .up:
            return "^"
        case .down:
            return "v"
        case .left:
            return "<"
        case .right:
            return ">"
        }
    }
    
    var nextClockwiseDirection: Self {
        switch self {
        case .up:
            return .right
        case .down:
            return .left
        case .left:
            return .up
        case .right:
            return .down
        }
    }
}

fileprivate enum Field: Hashable {
    case empty
    case obstacle
    case player(Direction)
    case visited
    
    init?(_ symbol: String) {
        switch symbol {
        case Self.empty.symbol:
            self = .empty
            
        case Self.obstacle.symbol:
            self = .obstacle
            
        case Self.visited.symbol:
            self = .visited
            
        case Self.player(.up).symbol:
            self = .player(.up)
            
        case Self.player(.down).symbol:
            self = .player(.down)
            
        case Self.player(.left).symbol:
            self = .player(.left)
            
        case Self.player(.right).symbol:
            self = .player(.right)
            
        default:
            return nil
        }
    }
    
    var symbol: String {
        switch self {
        case .empty:
            return "."
        case .obstacle:
            return "#"
        case let .player(direction):
            return direction.playerSymbol
        case .visited:
            return "X"
        }
    }
    
    var isPlayer: Bool {
        switch self {
        case .player:
            return true

        default:
            return false
        }
    }
    
    var playerDirection: Direction? {
        if case let .player(direction) = self {
            return direction
        } else {
            return nil
        }
    }
    
    var isPassable: Bool {
        switch self {
        case .empty, .visited, .player:
            return true

        case .obstacle:
            return false
        }
    }
}

fileprivate struct Position: Hashable {
    var x: Int
    var y: Int
    
    static func +(lhs: Position, rhs: Position) -> Position {
        Position(x: lhs.x + rhs.x, y: lhs.y + rhs.y)
    }
    
    static func +=(lhs: inout Position, rhs: Position) {
        lhs = lhs + rhs
    }
}

fileprivate struct Player: Hashable {
    var position: Position
    var direction: Direction
}

fileprivate extension [[Field]] {
    subscript(position: Position) -> Field? {
        get {
            let row = self[safe: position.y]
            return row?[safe: position.x]
        }
        mutating set {
            self[safe: position.y]?[safe: position.x] = newValue
        }
    }
}

fileprivate class Board {
    var player: Player
    var data: [[Field]]
    
    init(data: [[String]]) {
        self.data = Self.parseBoardData(data)
        self.player = Self.findPlayer(on: self.data)
    }
    
    func start() {
        // Stop when the player is off the board
        while data[player.position] != nil {
            drawBoard()
            if canMoveForward() {
                moveForward()
            } else {
                turnRight()
            }
        }
        
        print()
    }
    
    // Does not check for blocks
    func moveForward() {
        move(direction: player.direction)
    }
    
    func canMoveForward() -> Bool {
        let nextField = player.position + player.direction.directionVector
        // If there is no field (going out of the board, we return true, as this finishes the game
        return data[nextField]?.isPassable ?? true
    }
    
    func turnRight() {
        let newDirection = player.direction.nextClockwiseDirection
        
        // Update the board data
        data[player.position] = .player(newDirection)
        
        player.direction = newDirection
    }
    
    // Does not check for blocks
    private func move(_ amount: Int = 1, direction: Direction) {
        let directionVector = direction.directionVector
        // Recursively move step by step
        if amount > 1 {
            move(amount - 1, direction: direction)
        }

        let newPosition = player.position + directionVector
        assert(
            data[newPosition]?.isPassable ?? true,
            "Trying to move onto an impassable field (from \(player.position) to \(newPosition)). Target field has type \(String(describing: data[newPosition]))"
        )
        // Update the board data
        data[player.position] = .visited
        data[newPosition] = .player(player.direction)

        player.position = newPosition
    }
}

// MARK: - Parsing
extension Board {
    static func parseBoardData(_ data: [[String]]) -> [[Field]] {
        data.map { row in
            row.map { symbol in
                Field(symbol)!
            }
        }
    }
    
    static func findPlayer(on board: [[Field]]) -> Player {
        let row = board.first { currentRow in
            currentRow.contains { field in field.isPlayer }
        }!
        let y = board.firstIndex(of: row)!
        let player = row.first(where: { $0.isPlayer })!
        let x = row.firstIndex(of: player)!
        return Player(position: .init(x: x, y: y), direction: player.playerDirection!)
    }
}

// MARK: - Drawing
extension Board {
    func drawBoard() {
        let board = data.map { $0.map(\.symbol).joined() }
        fflush(stdout)
        print(board.joined(separator: "\n"), terminator: "\n\n\n\n")
    }
}

struct Day6Part1: Day {
    func run(input: String) throws -> String {
        let board = Board(data: input.components(separatedBy: .newlines).map { str in str.map(String.init) })
        board.start()
        
        // Count the visited fields
        let visitedFields = board.data.joined().count(where: { $0 == .visited })
        return "\(visitedFields)"
    }
    
    var testInput: String = """
    ....#.....
    .........#
    ..........
    ..#.......
    .......#..
    ..........
    .#..^.....
    ........#.
    #.........
    ......#...
    """
    
    var expectedTestResult: String = "41"
    
    var input: String = """
    ..........#.............................#...............#...........#....................#...........#............................
    ..............................#.......#...#.....#.....#...............#.#..#.......................#............#.................
    .............#...........#.#........#............#..........................#.........#.......#......#............................
    ......................................................#....#..#.............#................................#...#............##..
    ...............#.....#....................................#......................................................#................
    ..................##............#......#...............................................................#...................#......
    .#......#...........................................................#............................#................................
    #..#.............#...............................#.....#....#.............................#....#..............................#...
    #...##..........#.........................#.................................................#............#...............#........
    ............#...............#..............................................#.................................#..........##........
    ..............#...................#......##...#.....#....................#.......................................................#
    .#.....#....#......................#...#........................................#.#.............#.........#.......................
    #..#...............#........##.........#.....#..........#.....##.........................#.....#.#................................
    ...............#...............................#.....#.................................................#..##......................
    ......#...................#..........#...........................................#....#...........................................
    ...............................................#...#....##.................................................#.....#................
    .................#.........#..............................#........#...#...#...................................#..................
    ...........#..#.....#...#.........................#..........#.#.............#....#...................##..........................
    .........................................#.........................#.#............#...#...##............................#.........
    .....#......................................#....................................................#..............#.................
    ..................................................#..................#................#.............#.#..#..................#.....
    ............................................#.....#......................#........#..........................................#....
    .......#..........................#...#...................................#.........................#...#..........#......#.......
    ............#...........##........................................................................#......................#........
    #.#...............................................#........#..........#.#..#...#................................#.................
    ..#.........................#.#........................#....##..................................................#............#....
    .....................................................................................#...............#...........#..........#.....
    ....................#..........#................................#...............................................#.................
    #..............#.#...........#.........#..........#..........................#......................##........#.........#.........
    ....#....#...............................................................................#...#...........#............#...#...#...
    .......................................................##......................#...#................................#.............
    .......#...........##...........................#..............#..............................#...................#......#........
    ......#.........#..............................................................#........#..#..........#.......#..#...#.....#....#.
    ....#.............................................#........#....#..................................#..............................
    ..........#......#...........#....................................#..............#.......#...#............#.......................
    ...........................................................................................#.......#..............................
    .#..................................................#.............................#..................#...................#........
    ......#..#.#................#.....................#..................................#.............#...............#..............
    ...............................#..................#........#......................................................................
    ......................#..................................................................................#.........#..............
    ...............................................................................................................................#..
    .......#..............#...........................................................#......................#.......................#
    #...............................#..............................#.......#..............................#...#...#........#..........
    ............................#....#...#.........#....#................................................................#............
    .....................#.................................................................#..#....#..................#...............
    ......................#.............#.............................#...................................................#...........
    ....#.................#.#.........##................#.....#....................................................#.............#....
    ...............................#...#...................#.......................................#......#...........................
    ....#.............................................................................................................................
    ...#.......................................................................................................#............#.......#.
    ..#.............##.............................................................#...#............................#............#....
    ......................#.......#............#........................................................#..................#......#...
    ...................#.............#..................#..............................#............#........#...................#....
    ....................#...........#.........................................................#......#.......#...........#.....##.....
    ...........#.........................................#.............................#..............#..................#............
    ......................#.........#...................#......#...........................................#..........................
    ..#....#...#.............................#..............#.....................#............#...................................#..
    .....#.............................#....#..................................#...................#...#.............#................
    ...................#...#...........#........................#.............#........................#...#.............#..........#.
    ...#...........#......#.......#..............#......#..........#.....#............................................................
    ..#......................................................#......#...........................#...........#......#..#...............
    ........#............................#.#....................#...#...#......#.....#...............................................#
    .............#....#........#.........................................................................................#.........#..
    ....................................................................................................#.............................
    ..#........................#....#............................................................................#....................
    .......................................#.....#.#.......................................#......#........#.#...................#....
    .................#........#....................................#...#..#................................#..........................
    ...........#.................................................................................................#....................
    ......................#..................#...#.............#................##................#.......#...........#.........#.....
    ............#..#................#.............................................#............##..................##..........#......
    ......#.#.......................#............#...........................................................#........................
    #......................................#.#......^...............................................#.................................
    ........#...........................................................#...............#.............................................
    ...#.............................................#.................#...............#.............................#...#.#..........
    ....................#........#...........##.......................#.................#..................#................#.........
    #.................................................................................................................................
    ............#.......................................................................................#.#.........#..............#..
    ...............#....#............#..................................................#......##.................................#...
    .............................#.........#...............#......#.......#.................#........................#........#.......
    ......................................................#........................................................#.................#
    .................#.#...............#......................................................................................#....#..
    ........#.............#......................#...........#...........#......................................#..............#......
    ......................#......................#...........#.....#.....##............................................#....#.........
    .............#................................................................................#..........#.....#..................
    ............##...........................#.................................#..#.#....................................#............
    ..............................................................................................#............................#......
    ...#.............................#..#..#....................................#..............#....#.................................
    .....#..........................................................#.....#......#.........#..........................................
    ....##......#.....................#..........#..............#..................#.#..............#........#...........#....#.......
    .....#...#.........#............#............#.............................................................#......................
    .........#...................................#...........#.....................................##.....#............#..............
    .....##.#............##.....................#..........................#.................................#........#...............
    .......................#..............##...#...................................................#.........#........................
    ..#........#.......#...#..##............#....................................................................#...........#.....#..
    ..#.....................................................................#..............#.............#...................#........
    ...........#..........#..........#.....#.................................................................#..#.....................
    ..........#................#........................................................##.#...............................#.#......#.
    #............................................#...........................##...#.......................#.............#.............
    ..#............#........................................................................................................#.........
    ....................................................#....................#............#...............#..........................#
    ........................................................................#.......#.....................................#.#.........
    ................#..#......................#...........................................#...........................................
    ........................##............................................#.............##..........................#.......#....#....
    .........#.......#..............................#......#....#............#..................#...#.................................
    #.........#............................#....#.#..#.........................................................##.....................
    .#..##...............#....#.............................#...............#........#.......................................#......#.
    ...#............................................................#.....................#.................#.....#...................
    ...#...........#..#.............................#.....#.............................................................#.............
    ...#.........................#..............................................................................................##....
    .........................#...........................#.......................#...........#........................................
    .#..................................#.............................................................................................
    ....................................................................#...........##.....#.#.........#.....#........................
    ................#...............................#........#........................................................................
    ......#....#.................................#...................................#.#.........#.....#....................#.........
    ................#..............................#.......................#...#.....#.......#................#.......................
    ....................#......................................#..#...........#.#.................#...#.......................#.......
    .............#..#...#............................#.#...........................................#.......................#..........
    .........#..........#.................#....................................#.#..........................................#.........
    ....#.............#......................................................#...........#...........................#................
    ........#.#............................#...........................................#.................#..............#..........#..
    ..............#..........................#............#.........#....#...#.....#.........................#....#...............##..
    ...................#.........................................................#.......#........#..............#..........#.........
    .#........#....#..................................#..#.#...............#............#...........#.................................
    ...............................................................................................#.....#....#.............#.........
    ...........#..........#...........................................#.........#..............#................#..........#..........
    ............#.................................###..............#.#...............................................................#
    ......#...................................................................................#............#...#..........#.....#.....
    .............#..................#...................#......#.........#..#.......................#....#................#..........#
    ..#....##................................#.................#...........................#.......#....#...#..........#..............
    ...............................#......................................#.........#.............#......................#..........#.
    """
}
